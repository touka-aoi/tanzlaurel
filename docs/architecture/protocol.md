### サーバー用のheader定義

```jsx
header定義
  version    u8   (1)
  sessionID  u32  (4)
  seq        u16  (2)
  length     u16  (2)
  pad        u8   (3)
  timestamp  u32  (4)
-------------------
合計            16 byte
```

```jsx
payload定義
  datatype  u8 (1)
  subtype   u8 (1)
  pad       u8 (6)
----------------
合計             8 byte
```

### 最小ペイロードで実現したいこと

- 移動
- ボイスチャット
- ライブ
- コントロール

### データタイプ

- input ( ユーザー入力 )
- actor ( モーションデータ・移動データ )
  - spawn ( キャラ生成 )
  - update ( キャラ更新 )
- voice ( 音声 )
- control ( コントロール )

### ユーザーの種類

1. ユーザー ( 一般的なユーザーで入力によって移動する )
2. スーパーユーザー ( 特別なユーザーでボーンデータ・位置の送信によって移動する )

### ユーザーからデータを受信した時に起こること

- ユーザーは入力を送信するので、ユーザーの入力を溜めTickが起きたらゲームサーバーを更新、結果の位置を返信する
- スーパーユーザーはボーンデータ・位置の情報の差分を送信するので、サーバーで差分計算を行い最新位置をキャッシュする。Tick後、差分でゲームサーバーを更新、結果の位置を返信する。

### ユーザーがルームにJoinした時に起こること

- ユーザーはサーバーからキャッシュを受け取る
  - ユーザーのキャッシュ: 位置情報
  - スーパーユーザーのキャッシュ: 位置とボーン情報
- サーバーは初期位置でキャッシュを登録する

### 音声

- 音声はパースせずそのまま送信する。キャッシュもしない。
- 初期実装は全員配信。後ほど距離減衰を実装予定。

---

## 設計決定事項

### ヘッダー

| フィールド | 用途 |
|-----------|------|
| sessionID | 配信時: クライアントが他ユーザーを識別 / 受信時: サーバーで送信元検証 |
| seq | 順序保証・欠損検知用 |
| length | ペイロード長（バイト単位、ヘッダー後のデータ長） |
| pad | 16バイトアライメント用（将来拡張の余地あり） |
| timestamp | 送信者の時刻（クライアント送信時はクライアント時刻、サーバー送信時はサーバー時刻）

### データタイプ詳細

```
datatype (u8)
├── 1: input    - ユーザー入力
├── 2: actor    - モーション・移動データ
├── 3: voice    - 音声
└── 4: control  - コントロール

actor subtype (u8)
├── 1: spawn    - キャラ生成
├── 2: update   - キャラ更新
└── 3: despawn  - キャラ削除

control subtype (u8)
├── 1: join     - ルーム参加
├── 2: leave    - ルーム退出
├── 3: kick     - 強制退出
├── 4: ping     - ハートビート要求
├── 5: pong     - ハートビート応答
└── 6: error    - エラー通知
```

### ボーンデータ形式

- **変更ボーンのみ送信**（ビットマスク方式）
- 帯域効率を優先し、変更があったボーンのみを送信
- ビットマスクで変更ボーンを示し、続けてボーンデータを配置

### Tick設定

- **30fps固定**（約33.3ms間隔）
- ユーザー入力はTick間でバッファリング
- Tick時にゲームサーバー更新 → 結果配信

### 入力バッファリング

- spawnデータと差分データを足し合わせた**最新状態を1つだけ保持**
- 複数フレーム分の入力履歴は保持しない
- Tick時に保持している最新状態でゲームサーバーを更新

### バイナリフォーマット

- **バイトオーダー**: リトルエンディアン

### inputペイロード

```
input payload (8バイト)
  keyMask    u32  (4)  - キー入力ビットマスク (W/A/S/D/Jump等)
  pad        u32  (4)
```

### actorペイロード

```
actor position (28バイト)
  x          f32  (4)
  y          f32  (4)
  z          f32  (4)
  qx         f32  (4)  - quaternion x
  qy         f32  (4)  - quaternion y
  qz         f32  (4)  - quaternion z
  qw         f32  (4)  - quaternion w

bone data (16バイト/ボーン)
  qx         f32  (4)  - quaternion x
  qy         f32  (4)  - quaternion y
  qz         f32  (4)  - quaternion z
  qw         f32  (4)  - quaternion w

actor update (スーパーユーザー)
  bitmask    u128 (16) - 変更ボーンのビットマスク (最大128ボーン)
  position   28バイト
  bones      16バイト × 変更ボーン数
```

---

## TODO

- [ ] sessionID詐称対策の検討（サーバーで上書き or 検証して拒否）
- [ ] 音声の同時発話制限の検討（現状は制限なし）
- [ ] エラーコードの定義
- [ ] 再接続フロー（seq同期、状態復元）
- [ ] 不正入力検証（チート対策）
- [ ] Interest Management（大規模ルーム対応）
