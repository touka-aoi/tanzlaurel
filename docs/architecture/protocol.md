# プロトコル設計

## パケット構造図

```
┌─────────────────────────────────────────────────────────────────┐
│                         Packet                                   │
├─────────────────────────────────────────────────────────────────┤
│  Header (13 bytes)  │  PayloadHeader (2 bytes)  │  Payload (N)  │
└─────────────────────────────────────────────────────────────────┘

Header (13 bytes):
┌─────────┬─────────────┬─────────┬─────────┬────────────┐
│ version │  sessionID  │   seq   │ length  │ timestamp  │
│  (1B)   │    (4B)     │  (2B)   │  (2B)   │   (4B)     │
└─────────┴─────────────┴─────────┴─────────┴────────────┘
   0         1-4          5-6       7-8        9-12

PayloadHeader (2 bytes):
┌──────────┬─────────┐
│ dataType │ subType │
│   (1B)   │  (1B)   │
└──────────┴─────────┘
    0          1
```

---

## ヘッダー定義

### メインヘッダー (13 bytes)

```
Header定義
  version    u8   (1)
  sessionID  u32  (4)
  seq        u16  (2)
  length     u16  (2)
  timestamp  u32  (4)
-------------------
合計            13 byte
```

### ペイロードヘッダー (2 bytes)

```
PayloadHeader定義
  dataType  u8 (1)
  subType   u8 (1)
----------------
合計             2 byte
```

---

## ヘッダーフィールド詳細

| フィールド | 用途 |
|-----------|------|
| version | プロトコルバージョン（現在は1） |
| sessionID | 配信時: クライアントが他ユーザーを識別 / 受信時: サーバーで送信元検証 |
| seq | 順序保証・欠損検知用 |
| length | ペイロード長（バイト単位、ヘッダー後のデータ長） |
| timestamp | 送信者の時刻（クライアント送信時はクライアント時刻、サーバー送信時はサーバー時刻）|

---

## データタイプ

### 最小ペイロードで実現したいこと

- 移動
- ボイスチャット
- ライブ
- コントロール

### DataType階層

```
dataType (u8)
├── 1: input     - ユーザー入力
├── 2: actor2D   - 2Dモーション・移動データ
├── 3: voice     - 音声
├── 4: control   - コントロール
└── 5: actor3D   - 3Dモーション・移動データ（ボーン含む）

actor2D subType (u8)
├── 1: spawn    - 2Dキャラ生成
├── 2: update   - 2Dキャラ更新
└── 3: despawn  - 2Dキャラ削除

actor3D subType (u8)
├── 1: spawn    - 3Dキャラ生成
├── 2: update   - 3Dキャラ更新（ボーンデータ含む）
└── 3: despawn  - 3Dキャラ削除

control subType (u8)
├── 1: join     - ルーム参加
├── 2: leave    - ルーム退出
├── 3: kick     - 強制退出
├── 4: ping     - ハートビート要求
├── 5: pong     - ハートビート応答
├── 6: error    - エラー通知
└── 7: assign   - セッションID通知
```

---

## ペイロード定義

### Input ペイロード (4 bytes)

```
Input Payload:
┌────────────┐
│  keyMask   │
│   (4B)     │
└────────────┘

input payload (4バイト)
  keyMask    u32  (4)  - キー入力ビットマスク (W/A/S/D/Jump等)
```

### Actor2D Position (8 bytes)

```
Position2D:
┌─────┬─────┐
│  x  │  y  │
│(4B) │(4B) │
└─────┴─────┘
 0-3   4-7

actor2D position (8バイト)
  x          f32  (4)
  y          f32  (4)
```

### Actor3D Position (28 bytes)

```
Position:
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│  x  │  y  │  z  │ qx  │ qy  │ qz  │ qw  │
│(4B) │(4B) │(4B) │(4B) │(4B) │(4B) │(4B) │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┘
 0-3   4-7  8-11 12-15 16-19 20-23 24-27

actor position (28バイト)
  x          f32  (4)
  y          f32  (4)
  z          f32  (4)
  qx         f32  (4)  - quaternion x
  qy         f32  (4)  - quaternion y
  qz         f32  (4)  - quaternion z
  qw         f32  (4)  - quaternion w
```

### Bone Data (17 bytes/ボーン)

```
BoneData:
┌────────┬─────┬─────┬─────┬─────┐
│ boneID │ qx  │ qy  │ qz  │ qw  │
│  (1B)  │(4B) │(4B) │(4B) │(4B) │
└────────┴─────┴─────┴─────┴─────┘
   0      1-4  5-8  9-12  13-16

bone data (17バイト/ボーン)
  boneID     u8   (1)  - ボーンID
  qx         f32  (4)  - quaternion x
  qy         f32  (4)  - quaternion y
  qz         f32  (4)  - quaternion z
  qw         f32  (4)  - quaternion w
```

### Control Join (16 bytes)

```
JoinPayload:
┌──────────────────────────────┐
│        roomID (16B)          │
└──────────────────────────────┘

control join payload (16バイト)
  roomID     [16]byte  - ルームID (UUID)
```

### Control Leave

```
LeavePayload:
  (ペイロードなし - 現在のルームから退出)
```

### Actor2D Spawn

```
Actor2DSpawn:
┌─────────────────────────────┐
│      Position2D (8B)        │
└─────────────────────────────┘

actor2D spawn (8バイト)
  position   Position2D (8)
```

### Actor2D Update

```
Actor2DUpdate:
┌─────────────────────────────┐
│      Position2D (8B)        │
└─────────────────────────────┘

actor2D update (8バイト)
  position   Position2D (8)
```

### Actor3D Spawn

```
Actor3DSpawn:
┌─────────────────────────────┐
│       Position (28B)        │
└─────────────────────────────┘

actor3D spawn (28バイト)
  position   Position (28)
```

### Actor3D Update (スーパーユーザー用)

```
Actor3DUpdate:
┌───────────────┬─────────────────────────────┬─────────────────────────────────┐
│  bitmask(16B) │       Position (28B)        │  BoneData × N (17B × N)         │
└───────────────┴─────────────────────────────┴─────────────────────────────────┘

actor3D update (スーパーユーザー)
  bitmask    [16]byte  - 変更ボーンのビットマスク (最大128ボーン)
  position   28バイト
  bones      17バイト × 変更ボーン数
```

---

## メッセージフロー図

### ユーザー入力フロー

```
┌──────────┐                           ┌──────────┐
│  Client  │                           │  Server  │
└────┬─────┘                           └────┬─────┘
     │                                      │
     │  Input (keyMask)                     │
     │ ─────────────────────────────────────>
     │                                      │
     │                            ┌─────────┴─────────┐
     │                            │ Tick処理          │
     │                            │ - 入力バッファリング│
     │                            │ - ゲームサーバー更新│
     │                            └─────────┬─────────┘
     │                                      │
     │  Actor Broadcast (positions)         │
     │ <─────────────────────────────────────
     │                                      │
```

### ルーム参加フロー

```
┌──────────┐                           ┌──────────┐
│  Client  │                           │  Server  │
└────┬─────┘                           └────┬─────┘
     │                                      │
     │  Control/Join                        │
     │ ─────────────────────────────────────>
     │                                      │
     │                            ┌─────────┴─────────┐
     │                            │ - セッション登録    │
     │                            │ - 初期キャッシュ送信 │
     │                            │ - Spawn生成        │
     │                            └─────────┬─────────┘
     │                                      │
     │  Actor/Spawn (initial position)      │
     │ <─────────────────────────────────────
     │                                      │
     │  Cached actors broadcast             │
     │ <─────────────────────────────────────
     │                                      │
```

---

## ユーザーの種類

1. **ユーザー** ( 一般的なユーザーで入力によって移動する )
2. **スーパーユーザー** ( 特別なユーザーでボーンデータ・位置の送信によって移動する )

### ユーザーからデータを受信した時に起こること

- ユーザーは入力を送信するので、ユーザーの入力を溜めTickが起きたらゲームサーバーを更新、結果の位置を返信する
- スーパーユーザーはボーンデータ・位置の情報の差分を送信するので、サーバーで差分計算を行い最新位置をキャッシュする。Tick後、差分でゲームサーバーを更新、結果の位置を返信する。

### ユーザーがルームにJoinした時に起こること

- ユーザーはサーバーからキャッシュを受け取る
  - ユーザーのキャッシュ: 位置情報
  - スーパーユーザーのキャッシュ: 位置とボーン情報
- サーバーは初期位置でキャッシュを登録する

### 音声

- 音声はパースせずそのまま送信する。キャッシュもしない。
- 初期実装は全員配信。後ほど距離減衰を実装予定。

---

## 設計決定事項

### ボーンデータ形式

- **変更ボーンのみ送信**（ビットマスク方式）
- 帯域効率を優先し、変更があったボーンのみを送信
- ビットマスクで変更ボーンを示し、続けてボーンデータを配置
- 各ボーンはboneIDで識別

### Tick設定

- **60fps固定**（約16.7ms間隔）
- ユーザー入力はTick間でバッファリング
- Tick時にゲームサーバー更新 → 結果配信

### 入力バッファリング

- spawnデータと差分データを足し合わせた**最新状態を1つだけ保持**
- 複数フレーム分の入力履歴は保持しない
- Tick時に保持している最新状態でゲームサーバーを更新

### バイナリフォーマット

- **バイトオーダー**: リトルエンディアン

---

## サイズ定数一覧

| 定数名 | サイズ | 説明 |
|--------|-------|------|
| HeaderSize | 13 bytes | メインヘッダー |
| PayloadHeaderSize | 2 bytes | ペイロードヘッダー |
| PositionSize | 28 bytes | 位置 + quaternion |
| BoneDataSize | 17 bytes | boneID + quaternion |
| BitmaskSize | 16 bytes | 128ボーン対応ビットマスク |
| InputPayloadSize | 4 bytes | キーマスク |

---

## TODO

- [ ] sessionID詐称対策の検討（サーバーで上書き or 検証して拒否）
- [ ] 音声の同時発話制限の検討（現状は制限なし）
- [ ] エラーコードの定義
- [ ] 再接続フロー（seq同期、状態復元）
- [ ] 不正入力検証（チート対策）
- [ ] Interest Management（大規模ルーム対応）
